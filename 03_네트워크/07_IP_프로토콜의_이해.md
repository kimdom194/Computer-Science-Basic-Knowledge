- ### 네트워크 계층의 주요 기능

  - 기본 기능
    - 라우팅(Routing)
      - 송수신 호스트 사이의 패킷 전달 경로를 선택
    - 라우팅 과정 중에 수반되는 기능
      - 혼잡제어, 패킷 분할/병합
  - 라우팅
    - 라우팅 테이블
      - 네트워크 구성 형태에 관한 정보를 관리
  - 혼잡 제어 (Congestion Control)
    - 혼잡(congestion)
      - 네트워크에 패킷 수가 과도하게 증가되는 현상
    - 혼잡의 발생을 예방하거나 제거하는 기능
  - 패킷의 분할과 병합
    - 상위 계층에서 내려온 데이터는 하위 계층인 MAC 계층의 프레임 구조에 정의된  형식으로 캡슐화
    - 송신 호스트에서는 전송 전에 적절한 크기로 데이터를 분할(Segmentation)
    - 수신 호스트는 분할되어 수신한 데이터를 다시 병합(Reassemble)



- ### 서비스의 종류

  - 연결형 : 데이터 전송 전에 데이터의 전송 경로를 미리 결정
    - 연결형 서비스
    - 상대적으로 신뢰성이 높음
    - TCP: 전송 계층의 기능을 지원하는 연결형 프로토콜
  - 비연결형 : 데이터의 전송 경로를 사전에 결정하지 않고 패킷 단위로 결정
    - 비연결형 서비스
    - 패킷의 전달 순서
      - 패킷이 서로 다른 경로로 전송되므로 도착 순서가 일정하지 않음
      - 상위 계층에서 순서를 재조정해야 함
    - 패킷 분실 가능성
      - 패킷의 100% 도착을 보장하지 않음
      - 상위 계층에서 패킷 분실 오류를 복구해야 함
    - 인터넷 환경의 예
      - IP: 네트워크 계층의 기능을 지원하는 비연결형 프로토콜
      - UDP: 전송 계층의 기능을 지원하는 비연결형 프로토콜



- ### 라우팅

  - 패킷의 전송 경로를 지정
  - 전송 경로 결정시 고려 사항
    - 공평 원칙: 다른 패킷의 우선 처리를 위해 다른 패킷이 손해를 보면 안됨
    - 효율 원칙: 전체 네트워크의 효율성에 대해 고려해야 함
      - 패킷의 평균지연시간, 중간에 거쳐가는 라우터 수 등
    - 정적/동적 라우팅
      - 정적(Static) 라우팅
        - 패킷 전송이 이루어지기 전에 경로 정보를 라우터가 미리 저장하여 중개
        - 최적의 라우팅 정보를 개별 라우터에 저장하여 관리
        - 단점
        - 경로 정보의 갱신이 어려우므로, 네트워크 변화/네트워크 혼잡도 대처 부족
      - 동적(Dynamic) 라우팅
        - 라우터의 경로 정보를 네트워크 상황에 따라 적절하게 변경
        - 경로정보 변경 주기에 따른 보완 가능
        - 단점
        - 복잡한 작업 추가로 필요
        - 경로 정보의 수집과 관리로 인한 성능 저하
  - HELLO/ECHO 패킷
    - HELLO
      - 주변 라우터에 HELLO 패킷을 보내어 주변 경로 정보를 파악하는 용도
    - ECHO
      - 라우터 사이의 전송 지연 시간을 측정하는 용도
  - 임의의 라우터가 획득한 정보를 각 라우터에 통보함으로써 정보 공유
    - 개별 라우터에 도착하는 시간 차이로 인한 정보 불일치 발생 가능성
    - 변화되는 상황에서 일관성 유지가 관건



- ##### 라우팅 테이블

  - 라우터가 패킷의 적절한 경로를 찾기 위한 가장 기본적인 도구
  - 필수 정보: 목적지 호스트, 다음 홉
    - 목적지 호스트: 패킷의 최종 목적지가 되는 호스트 주소
    - 다음 홉: 목적지 호스트까지 패킷을 전달하기 위한 인접 경로



- ##### 라우팅 정보의 처리

  - 소스(Source) 라우팅
    - 송신 호스트가 패킷의 전달 경로를 결정하는 방식
    - 전송 경로는 전송 패킷 내부에 기록됨
  - 분산(Distributed) 라우팅
    - 라우팅 정보를 분산하여 관리하는 방식
    - 호스트의 개수가 많아질수록 효과적
  - 중앙(Centralized) 라우팅
    - 특정 호스트(RCC: Routing Control Center)가 모든 라우팅 정보를 관리
    - 송신 호스트는 패킷 전송 전에 RCC에게 경로 정보를 얻어서 소스  라우팅으로 전송
    - 호스트의 개수가 많아질수록 비효율적
  - 계층(Hierarchical) 라우팅
    - 분산 라우팅과 중앙 라우팅의 조합
    -  네트워크 규모가 커질수록 매우 효과적임



- ### 혼잡제어와 흐름제어

  - 흐름 제어: 송수신 호스트 사이의 전송 속도 문제
  - 혼잡 제어: 네트워크에서의 전송 능력 문제
    - 혼잡의 원인
      - 타임 아웃 기능에 의한 패킷의 재전송으로 혼잡도 증가
        - 초기 혼잡 과정에서 타임 아웃 시간이 작으면 혼잡도가 급격히 증가
        - 패킷 도착 순서가 다른 상황에서 패킷을 분실 처리하면 타임아웃 증가 -> go-back-N과 Selective Repeat
        - 의도적으로 피기배킹을 사용하면 응답 시간이 느려져 타임아웃 증가
        - 패킷 생존 시간을 작게 하면 패킷이 강제로 제거되어 타임아웃 증가
    - 라우팅 알고리즘
      - 혼잡이 발생하지 않는 경로를 배정하도록 설계
      - 혼잡이 발생하는 경로를 선택하면 혼잡이 주변으로 확대됨
    - 트레픽 성형
      - 혼잡의 발생은 트레픽이 특정 시간에 집중되는 버스트(burst) 현상이 원인
      - 패킷 발생 정도를 네트워크에서 예측 가능한 정도로 조절하는 기능이 필요
      - 리키 버킷 알고리즘
    - 혼잡 제거
      - 특정 지역의 혼잡이 다른 지역으로 확대되지 않도록 하는 것이 중요
      - 자원 예약 방식
        - 호스트와 서브넷이 미리 네트워크 자원의 사용 정도를 협상하여 사전 예약
        - 단점 : 자원 낭비 가능성
      - 초크(Choke) 패킷
        - 출력 경로를 사용하는 빈도를 모니터
        - 한계치가 넘어가면 송신 호스트에게 주의 표시
        - 초크 패킷을 받은 호스트는 송신 패킷 양을 줄임 (초크 패킷이 더 이상 오지 않을 때까지)



- ### 라우팅 프로토콜의 이해

  - 간단한 라우팅 프로토콜
    - 최단 경로 라우팅
      - 거리 기준은 다양하지만 중간에 거쳐가는 홉(hop) 수로 판단
      - 패킷이 목적지로 가는 동안 거치는 라우터 수가 최소가 되도록 경로를 선택
    - 플러딩(Flooding)
      - 라우터가 입력된 패킷을 출력 가능한 모든 경로로 중개하는 방식
      - 네트워크에 패킷이 무한 개 만들어질 위험
      - 홉 수를 일정 범위로 제한하고, 제거
      - 중요한 데이터를 모든 호스트에게 동시에 전달하는 환경에서 제한적으로 사용
  - 거리-벡터 프로토콜 
    - 라우터가 자신과 직접 연결된 주변 라우터에게 라우팅 정보를 교환하는 방식
      - 전체 네트워크에 대한 지식
      - 이웃 라우터에게만 전달
      - 일정한 주기로 정보 공유
    - 교환 정보는 전체 네트워크에 속하는 개별 네트워크까지 걸리는 거리 정보
    - 개별 라우터에서 유지하는 필수 정보
      - 링크 벡터: 직접 연결된 네트워크에 대한 연결 정보
      - 거리 벡터: 전체 개별 네트워크에 대한 거리 정보
      - 다음 홉 벡터: 개별 네트워크로 가기 위한 다음 홉 정보
    - RIP(Routing Information Protocol)
      - 거리 벡터 방식
      - 소규모 네트워크 환경에 적합
      - 주변 라우터가 제공하는 거리 벡터 정보가 임의의 짧은 시간 내에 모두 도착해야
        - 현실적으로 구현이 어려움 (UDP 사용 – 패킷 손실 가능성)
      - 라우팅 정보 수정하는 경우
        - 거리 벡터 정보가 새로운 네트워크 주소면 적용
        - 목적지까지의 지연이 더 적으면 기존 경로를 대체
        - 거리 벡터 정보가 입력되면 등록 정보를 수정
  - 링크상태 프로토콜
    - 거리-벡터 프로토콜의 단점 개선
      - 주변 상황에 변화가 있을 때
      - 주변 라우터까지의 정보를
      - 모든 라우터에게 전달
    - 플러딩(Flooding) 방식을 사용해서 정보 전달
    - OSPF(Open Shortest Path First) 프로토콜
  - 외부 라우팅 프로토콜 
    - 외부 라우팅 프로토콜에서 사용하는 경로 벡터(Path Vector)는 경로에 관한
      거리 정보 값이 필요 없는 방식
    - 내부 라우팅 프로토콜과의 차이
      - 거리(비용)에 대한 처리 과정이 없음
      - 목적지 네트워크에 도착하기 위한 자율시스템에 대한 내용만 포함
    - BGP(Border Gateway Protocol)
      - 인터넷에서 많이 사용
      - 서로 다른 종류의 자율시스템 간 정보 교환 가능
      - TCP를 이용하여 정보 교환
      - 메시지 종류
        - Open
          - 연관(Relationship) 생성
        - Update
          - 경로 관련 정보 전달
        - KeepAlive
          - Open에 대한 응답 기능과 주기적인 연관 확인 기능
        - Notification
          - 오류 상태 통보
      - 계층적 라우팅 필요성
        - 평면적 라우팅은 확장이 어려움
          - 저장 공간, 합의에 도달하는 시간, 통신
        - 목적지에 이르는 거리가 멀수록 더 적은 정보를 이용하는 것이 타당
        - 해결 방안 : 영역 계층구조 (Area Hierarchy)
      - 영역(area)
        - 망을 영역들로 분할
          - 각 영역에 서브-영역 존재 가능
        - 망 노드는 계층적 주소 부여
        - 영역 내부
          - 각 노드는 다른 노드로 가는 경로 보유
        - 영역 외부
          - 각 노드는 다른 top-level 영역으로 가는 경로만 보유
          - 영역 간 패킷은 적절한 border router에게 전달



- ### IP 프로토콜

  - 패킷 분할 관련 필드
    - 상위 계층에서 내려온 데이터가 하나의 패킷으로 전달하기에 너무 큰 경우 분할하여 전송
    - Identification(식별자 혹은 구분자)
      - 분할되지 않은 패킷: 값을 순차적으로 증가
      - 분할된 패킷: 동일한 번호 부여
    - DF(Don’t Fragment): 패킷 분할 금지
    - MF(More Fragment)
      - 분할된 패킷의 처음과 중간: 1
      - 분할된 패킷의 마지막: 0
    - Fragment Offset (13bits)
      - 분할되기 전 데이터에서의 상대적인 위치 정보
      - 8 바이트의 배수로 지정
  - 주소 관련 필드
    - Source Address: 송신 호스트의 IP 주소
    - Destination Address: 수신 호스트의 IP 주소
    - IP 주소 체계
      - Network : NIC에서 할당
      - Host : 개별 망에서 관리
      - 클래스 A
        - 0.0.0.0 ~ 127.255.255.255
      - 클래스 B
        - 128.0.0.0 ~ 191.255.255.255
      - 클래스 C
        - 192.0.0.0 ~ 223.255.255.255
      - 클래스 D
        - 224.0.0.0 ~ 239.255.255.255
      - 클래스 E
        - 240.0.0.0 ~ 255.255.255.255
  - 기타 필드
    - Version Number
      - 일반적으로 4 (IPv4)
    - Header Length
      - 헤더 길이를 32 비트 단위로 표시
      - IPv4의 경우 일반적으로 5
    - Packet Length: 헤더를 포함한 패킷의 전체 길이
    - Time To Live(TTL)
      - 패킷의 생존 시간
      - 라우터를 거칠 때마다 1씩 감소되며, 0이 되면 네트워크에서 강제로 제거
    - Transport Protocol
      - 상위 계층 프로토콜 (ICMP : 1, TCP : 6, UDP : 17)
    - Header Checksum
      - 우선 이 필드 값을 0으로 하고 값을 계산하여 채움
      - 헤더 오류 검출
    - Options
      - 망 관리나 보안 목적으로 부여 가능
    - Padding
  - 분할의 필요성
    - 네트워크에서 다루는 프레임의 크기가 다르다
      - X.25, Ethernet
    - 여러 종류의 네트워크를 걸쳐 패킷 전달